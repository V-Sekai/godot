#!/usr/bin/env python
from misc.utility.scons_hints import *
import os

Import("env")
Import("env_modules")

# TinyUSDZ is a header-only library with some source files
# Check if TinyUSDZ is available
# Use SCons Dir() to resolve paths relative to SConstruct root
tinyusdz_path = Dir("#modules/openusd/thirdparty/tinyusdz")
tinyusdz_include = tinyusdz_path.Dir("src")
tinyusdz_hh = tinyusdz_include.File("tinyusdz.hh")

if not tinyusdz_hh.exists():
    print("")
    print("=" * 60)
    print("WARNING: TinyUSDZ not found.")
    print("=" * 60)
    print("The openusd module requires TinyUSDZ to be available.")
    print("")
    print("TinyUSDZ should be cloned via git subrepo:")
    print("  cd /path/to/godot")
    print("  git subrepo clone https://github.com/lighttransport/tinyusdz.git modules/openusd/thirdparty/tinyusdz -b release")
    print("")
    print("=" * 60)
    print("")
    # Exit early - don't build this module if TinyUSDZ isn't available
    Return()

env_usd = env_modules.Clone()

# Add TinyUSDZ include path for all source files
env_usd.Prepend(CPPPATH=[tinyusdz_include.abspath])
env_usd.Prepend(CPPEXTPATH=[tinyusdz_include.abspath])

# Add OpenSubdiv include path from the subdiv module
# The subdiv module provides OpenSubdiv headers
# TinyUSDZ includes <opensubdiv/far/primvarRefiner.h>, so we need the parent directory
opensubdiv_base_path = Dir("#modules/subdiv/thirdparty")
env_usd.Prepend(CPPPATH=[opensubdiv_base_path.abspath])
env_usd.Prepend(CPPEXTPATH=[opensubdiv_base_path.abspath])

module_obj = []

# TinyUSDZ is mostly header-only, but we need to compile some source files
# Add TinyUSDZ source files to the build
# Exclude optional dependencies: nanobind (Python bindings), pybind11
tinyusdz_src_path = tinyusdz_include

# Files that require optional dependencies we don't need
excluded_files = [
    "nanobind-bindinds.cc",  # Requires nanobind (Python bindings)
    "pybind11-bindings.cc",  # Requires pybind11 (Python bindings)
    "python-bindings.cc",    # Requires pybind11 (Python bindings)
    # subdiv.cc is now included since we have the subdiv module with OpenSubdiv
]

# Get all .cc and .cpp files, then filter out excluded ones
all_cc_files = Glob(os.path.join(tinyusdz_src_path.abspath, "*.cc"))
all_cpp_files = Glob(os.path.join(tinyusdz_src_path.abspath, "*.cpp"))

# Filter out files that require optional dependencies
# SCons File nodes: convert to string path, get basename, check against excluded list
def should_include_file(file_node):
    file_path = str(file_node)
    file_name = os.path.basename(file_path)
    return file_name not in excluded_files

filtered_cc_files = [f for f in all_cc_files if should_include_file(f)]
filtered_cpp_files = [f for f in all_cpp_files if should_include_file(f)]

env_usd.add_source_files(module_obj, filtered_cc_files)
env_usd.add_source_files(module_obj, filtered_cpp_files)

# Export source files (export functionality merged into USDDocument)
env_usd.add_source_files(module_obj, "usd_export_settings.cpp")
env_usd.add_source_files(module_obj, "usd_mesh_export_helper.cpp")
env_usd.add_source_files(module_obj, "usd_mesh_import_helper.cpp")
env_usd.add_source_files(module_obj, "usd_state.cpp")
env_usd.add_source_files(module_obj, "usd_plugin.cpp")

# Import source files (GLTF-based) - merged with export functionality
env_usd.add_source_files(module_obj, "usd_document.cpp")
env_usd.add_source_files(module_obj, "usd_import_state.cpp")

if env.editor_build:
	env_usd.add_source_files(module_obj, "editor_import/*.cpp")

env.modules_sources += module_obj
