#!/usr/bin/env python
from misc.utility.scons_hints import *
import os

Import("env")
Import("env_modules")

# TinyUSDZ is a header-only library with some source files
# Check if TinyUSDZ is available
# Use SCons Dir() to resolve paths relative to SConstruct root
tinyusdz_path = Dir("#modules/openusd/thirdparty/tinyusdz")
tinyusdz_include = tinyusdz_path.Dir("src")
tinyusdz_hh = tinyusdz_include.File("tinyusdz.hh")

if not tinyusdz_hh.exists():
    print("")
    print("=" * 60)
    print("WARNING: TinyUSDZ not found.")
    print("=" * 60)
    print("The openusd module requires TinyUSDZ to be available.")
    print("")
    print("TinyUSDZ should be cloned via git subrepo:")
    print("  cd /path/to/godot")
    print("  git subrepo clone https://github.com/lighttransport/tinyusdz.git modules/openusd/thirdparty/tinyusdz -b release")
    print("")
    print("=" * 60)
    print("")
    # Exit early - don't build this module if TinyUSDZ isn't available
    Return()

env_usd = env_modules.Clone()

# Add TinyUSDZ include path for all source files
env_usd.Prepend(CPPPATH=[tinyusdz_include.abspath])
env_usd.Prepend(CPPEXTPATH=[tinyusdz_include.abspath])

module_obj = []

# TinyUSDZ is mostly header-only, but we need to compile some source files
# Add TinyUSDZ source files to the build
tinyusdz_src_path = tinyusdz_include
env_usd.add_source_files(module_obj, Glob(os.path.join(tinyusdz_src_path.abspath, "*.cc")))
env_usd.add_source_files(module_obj, Glob(os.path.join(tinyusdz_src_path.abspath, "*.cpp")))

# Export source files
env_usd.add_source_files(module_obj, "usd_document.cpp")
env_usd.add_source_files(module_obj, "usd_export_settings.cpp")
env_usd.add_source_files(module_obj, "usd_mesh_export_helper.cpp")
env_usd.add_source_files(module_obj, "usd_mesh_import_helper.cpp")
env_usd.add_source_files(module_obj, "usd_state.cpp")
env_usd.add_source_files(module_obj, "usd_plugin.cpp")

# Import source files (GLTF-based)
env_usd.add_source_files(module_obj, "usd_import_document.cpp")
env_usd.add_source_files(module_obj, "usd_import_state.cpp")

if env.editor_build:
	env_usd.add_source_files(module_obj, "editor_import/*.cpp")

env.modules_sources += module_obj
